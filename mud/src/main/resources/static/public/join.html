<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mud</title>
  <link rel="stylesheet" href="global.css" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .join-page {
      background-color: #ffffff;
      display: flex;
      flex-direction: row;
      justify-content: center;
      width: 100%;
    }

    .join-page .div {
      background-color: #ffffff;
      width: 1440px;
      height: 1024px;
      position: relative;
    }

    .join-login {
      width: 303px;
      top: 69px;
      left: 1135px;
      font-family: "Playfair-Bold", Helvetica;
      font-weight: 700;
      color: #000000;
      font-size: 30px;
      position: absolute;
      letter-spacing: 0;
      line-height: normal;
    }

    .join-page .overlap-group-2 {
      position: absolute;
      width: 574px;
      height: 676px;
      top: 190px;
      left: 419px;
    }

    .join-page .rectangle {
      position: absolute;
      width: 600px;
      height: 670px;
      top: 100px;
      left: 0;
      background-color: #fbf6f6;
    }

    .join-page .text-wrapper-2 {
      position: absolute;
      width: 150px;
      top: 60px;
      left: 2px;
      font-family: "Pathway Extreme-Light", Helvetica;
      font-weight: 300;
      color: #0000008a;
      font-size: 29px;
      letter-spacing: 0;
      line-height: normal;
    }

.rectangle-input {
  position: absolute;
  width: 446px;
  height: 56px;
  padding: 20px 15px; /* 위아래 padding을 20px로 늘려줍니다 */
  font-size: 18px;
  font-family: "Playfair Display-Regular", Helvetica;
  color: #000;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  box-sizing: border-box;
}

    .rectangle-input::placeholder {
      color: #aaa;
    }

.join-button {
  position: absolute;
  top: 670px;
  left: 50%;
  transform: translateX(-50%);
  width: 220px; /* 버튼 크기 줄이기 */
  height: 57px; /* 버튼 크기 줄이기 */
  line-height: 50px;
  background-color: #bc878791;
  color: #fff;
  font-size: 24px; /* 텍스트 크기 살짝 키우기 */
  text-align: center;
  border-radius: 6px;
  cursor: pointer;
}

    .join-page .text-wrapper-6,
    .join-page .text-wrapper-7,
    .join-page .text-wrapper-8,
    .join-page .text-wrapper-9,
    .join-page .text-wrapper-11 {
      position: absolute;
      font-family: "Playfair Display-SemiBold", Helvetica;
      font-weight: 600;
      color: #00000063;
      font-size: 24px;
      letter-spacing: 0;
      line-height: normal;
      margin-bottom: 30px;
    }

    .join-page .text-wrapper-6 { top: 150px; left: 59px; }
    .join-page .text-wrapper-7 { top: 253px; left: 59px; }
    .join-page .text-wrapper-8 { top: 360px; left: 59px; }
    .join-page .text-wrapper-9 { top: 460px; left: 59px; }
    .join-page .text-wrapper-11 { top: 560px; left: 59px; }

    input#userId { top: 180px; left: 52px; }
    input#password { top: 283px; left: 52px; }
    input#confirmPassword { top: 390px; left: 52px; }
    input#username { top: 490px; left: 52px; }
    input#phone { top: 590px; left: 52px; }

    .join-page .checkboxes {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
      position: absolute;
      top: 100px;
      left: 445px;
    }

    .join-page .state-layer {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 11px;
      position: relative;
      flex: 0 0 auto;
      border-radius: 100px;
    }

    .join-page .container {
      position: relative;
      width: 22px;
      height: 22px;
      background-color: #eaddff;
      border-radius: 2px;
    }

  </style>
</head>
<body>

<div class="join-page">
  <div class="div">
    <div id="header"></div>

    <div class="overlap-group-2">
      <div class="rectangle"></div>
      <div class="text-wrapper-2">Join</div>

      <div class="text-wrapper-6">ID</div>
      <input id="userId" class="rectangle-input" type="text" placeholder="6-20자의 영문, 숫자 포함" />
      <button type="button" id="checkDuplicateBtn">중복 확인</button>

      <div class="text-wrapper-7">Password</div>
      <input id="password" class="rectangle-input" type="password" placeholder="8-24자의 영문, 숫자 포함" />

      <div class="text-wrapper-8">Confirm Password</div>
      <input id="confirmPassword" class="rectangle-input" type="password" placeholder="비밀번호를 다시 입력하세요" />

      <div class="text-wrapper-9">Name</div>
      <input id="username" class="rectangle-input" type="text" placeholder="이름을 입력하세요" />

      <div class="text-wrapper-11">Phone</div>
      <input id="phone" class="rectangle-input" type="text" placeholder="숫자만 입력하세요" />

      <div id="joinButton" class="join-button">Join</div>
    </div>
  </div>
</div>

<script>

  fetch('header.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('header').innerHTML = data;
    });

const duplicateCheckedField = document.createElement('input');
  const userIdInput = document.getElementById('userId');
  const passwordInput = document.getElementById('password');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const nameInput = document.getElementById('username');
  const phoneInput = document.getElementById('phone');
  const joinButton = document.getElementById('joinButton');

        // 중복 확인 버튼 클릭 이벤트
        document.getElementById('checkDuplicateBtn').addEventListener('click', function () {
            const userId = document.getElementById('userId').value;

            if (!userId.trim()) {
                showCustomAlert('아이디를 입력하세요.');
                return;
            }

                        // AJAX 요청으로 중복 확인
            fetch(`/users/check-duplicate?userId=${encodeURIComponent(userId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.isDuplicate) {
                        showCustomAlert('이미 사용 중인 아이디입니다.');
                        duplicateCheckedField.value = 'false';
                    } else {
                        showCustomAlert('사용 가능한 아이디입니다.');
                        duplicateCheckedField.value = 'true';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showCustomAlert('중복 확인 중 오류가 발생했습니다.');
                    duplicateCheckedField.value = 'false';
                });
        });

  joinButton.addEventListener('click', async function () {
    const userId = userIdInput.value.trim();
    const password = passwordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();
    const username = nameInput.value.trim();
    const phone = phoneInput.value.trim();

    if (!userId || !password || !confirmPassword || !username || !phone) {
      alert('모든 항목을 입력해야 합니다.');
      return;
    }
     if (!/^[a-zA-Z0-9]{6,20}$/.test(userId)) {
      alert('ID는 6~20자의 영문, 숫자 조합이어야 합니다.');
      return;
    }

    if (!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,24}$/.test(password)) {
      alert('비밀번호는 8~24자 영문과 숫자를 포함해야 합니다.');
      return;
    }
    if (password !== confirmPassword) {
      alert('비밀번호가 일치하지 않습니다.');
      confirmPasswordInput.focus();
      return;
    }
    if (!/^[0-9]+$/.test(phone)) {
      alert('전화번호는 숫자만 입력해야 합니다.');
      phoneInput.focus();
      return;
    }

    if (duplicateCheckedField.value !== 'true') {
      showCustomAlert('아이디 중복 확인을 먼저 해주세요.');
      return;
    }

    const userData = {
      userId,
      password,
      username,
      phone
    };

    try {
      const response = await fetch('http://localhost:8080/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });

      if (response.ok) {
        alert('회원가입 성공! 로그인 페이지로 이동합니다.');
        window.location.href = "login.html";
      } else {
        const errorText = await response.text();
        alert('회원가입 실패: ' + errorText);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('서버 연결에 실패했습니다.');
    }
  });
</script>
</body>
</html>
