<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mud</title>
    <link rel="stylesheet" href="global.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
<style>
    .my-page {
       background-color: #ffffff;
        display: flex;
        flex-direction: row;
        justify-content: center;
        width: 100vw;
        height: 100vh;
        align-items: stretch;
        box-sizing: border-box;
        padding: 20px;
     }

     .my-page .div {
       background-color: #ffffff;
       width: 1440px;
       height: 1024px;
       position: relative;
     }

     .my-page .overlap-group-2 {
       position: absolute;
       width: 700px;
       height: 800px;
       top: 400px;
       left: 350px;
       background-color: #fbf6f6;
     }

     .my-page .edit-wrapper {
       position: absolute;
       width: 160px;
       height: 100px;
       top: 630px;
       left: 140px;
       background-image: url(./img/rectangle-14.png);
       background-size: 100% 100%;
     }

     .my-page .edit {
       position: absolute;
       width: 60px;
       height: 60px;
       top: 10px;
       left: 50px;
     }

     .my-page .overlap-2 {
       position: absolute;
       width: 160px;
       height: 100px;
       top: 630px;
       left: 390px;
     }

     .my-page .rectangle {
       position: absolute;
       width: 160px;
       height: 100px;
       top: 0;
       left: 0;
     }

     .my-page .text-wrapper-2 {
       width: 81px;
       top: 10px;
       left: 40px;
       color: #fffafa;
       font-size: 40px;
       position: absolute;
       font-family: "Playfair Display-Regular", Helvetica;
       font-weight: 400;
       letter-spacing: 0;
       line-height: normal;
     }

     .my-page .div-wrapper {
       position: absolute;
       width: 600px;
       height: 100px;
       top: 60px;
       left: 44px;
       background-image: url(./img/rectangle-19.png);
       background-size: 100% 100%;
     }

     .my-page .text-wrapper-3 {
       position: absolute;
       top: 22px;
       left: 24px;
       font-family: "Playfair Display-SemiBold", Helvetica;
       font-weight: 600;
       color: #00000033;
       font-size: 35px;
       letter-spacing: 0;
       line-height: normal;
     }

     .my-page .overlap-3 {
       position: absolute;
       width: 600px;
       height: 100px;
       top: 210px;
       left: 44px;
       background-image: url(./img/rectangle-20.png);
       background-size: 100% 100%;
     }

     .my-page .text-wrapper-4 {
       position: absolute;
       top: 22px;
       left: 24px;
       font-family: "Playfair Display-SemiBold", Helvetica;
       font-weight: 600;
       color: #00000033;
       font-size: 35px;
       letter-spacing: 0;
       line-height: normal;
     }

     .my-page .overlap-4 {
       position: absolute;
       width: 600px;
       height: 100px;
       top: 360px;
       left: 44px;
       background-image: url(./img/rectangle-23.png);
       background-size: 100% 100%;
     }

     .my-page .overlap-5 {
       position: absolute;
       width: 600px;
       height: 100px;
       top: 510px;
       left: 44px;
       background-image: url(./img/rectangle-24.png);
       background-size: 100% 100%;
     }

     .my-page .text-wrapper-5 {
       position: absolute;
       top: 22px;
       left: 24px;
       font-family: "Playfair Display-SemiBold", Helvetica;
       font-weight: 600;
       color: #00000033;
       font-size: 34px;
       letter-spacing: 0;
       line-height: normal;
     }

     .my-page .text-wrapper-6 {
       width: 400px;
       top: 750px;
       left: 150px;
       color: #00000040;
       font-size: 25px;
       position: absolute;
       font-family: "Playfair Display-Regular", Helvetica;
       font-weight: 400;
       letter-spacing: 0;
       line-height: normal;
     }

     .my-page .text-wrapper-7 {
       position: absolute;
       width: 141px;
       top: 350px;
       left: 360px;
       font-family: "Pathway Extreme-Light", Helvetica;
       font-weight: 300;
       color: #0000008a;
       font-size: 36px;
       letter-spacing: 0;
       line-height: normal;
     }

        .my-page .button-hover {
        cursor: pointer;
        transition: all 0.3s ease;    }

        .my-page .button-hover:hover {
        transform: scale(1.05);
        opacity: 0.9;
        }

        .my-page .save-wrapper {
        background-image: url(./img/rectangle-14.png);
        background-size: 100% 100%;
        color: #fffafa;
        font-size: 27px;
        font-family: "Playfair Display-Regular", Helvetica;
        font-weight: 400;
        letter-spacing: 0;
        position: absolute;
        width: 160px;
        height: 100px;
        top: 630px;
        left: 140px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: all 0.3s ease;
        text-align: center;
    }

    .my-page .save-wrapper:hover {
        transform: scale(1.05);
        opacity: 0.9;
    }

    .my-page .save-button {
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 40px;
        top: 25px;
        left: 39px;
        position: absolute;
    }

        /* 모달 전체 화면 */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* 배경 어두운 색 */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 0.3s ease;
    }

    /* 모달 내부 컨텐츠 */
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 400px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    /* 제목 스타일 */
    .modal-content h2 {
        font-size: 20px;
        margin-bottom: 20px;
        font-weight: 600;
        color: #333;
    }

    /* 비밀번호 입력창 */
    .modal-content input[type="password"] {
        width: 100%;
        padding: 12px;
        margin: 15px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        outline: none;
        transition: border 0.3s ease;
    }

    /* 비밀번호 입력창에 포커스 했을 때 스타일 */
    .modal-content input[type="password"]:focus {
        margin: 5px 0 15px 0; /* margin-top을 줄여서 위로 위치 */
        border-color: #007BFF;
    }

    /* 버튼 스타일 */
    .submit-btn {
        background-color: #FFB6C1;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background-color 0.3s ease;
    }

    .submit-btn:hover {
        background-color: #FFB68;
    }
    #nav-buttons {
      position: absolute;
      top: 60px;
      right: 0px;
      font-size: 30px;
      z-index: 1000;
    }
    #nav-buttons a {
      margin-left: 20px;
      text-decoration: none;
      color: #333;
      font-weight: bold;
    }

    .clickable {
      cursor: pointer;
    }

    .id,
    .pw,
    .name,
    .email {
      position: absolute;
      font-family: "Playfair Display-SemiBold", Helvetica;
      font-weight: 600;
      color: #00000063;
      font-size: 30px;
      letter-spacing: 0;
      line-height: normal;
      margin-bottom: 30px;
    }

    .id { top: 28px; left: 54px; }
    .pw { top: 178px; left: 54px; }
    .name { top: 328px; left: 54px; }
    .email { top: 478px; left: 54px; }
</style>
  <body>
    <div class="my-page">
        <div class="div">
            <div id="nav-buttons"></div>
            <div id="header"></div>
            <div class="overlap-group-2">
            <div class="edit-wrapper">
                <img class="edit" src="img/edit.png" onclick="editInfo()"/>
            </div>
            <div class="save-wrapper" style="display:none">
                <div class="save-button" id="saveButton" onclick="saveChanges()">저장</div>
            </div>
            <!-- 비밀번호 입력 모달 -->
            <div id="passwordModal" class="modal">
                <div class="modal-content">
                    <h2>비밀번호 입력</h2>
                    <input type="password" id="passwordInput" placeholder="비밀번호를 입력하세요" />
                    <button class="submit-btn" onclick="submitPassword()">확인</button>
                </div>
            </div>

            <div class="overlap-2">
            <img class="rectangle" src="img/rectangle 25.png" />
            <div class="text-wrapper-2" onclick="deleteAccount()">탈퇴</div>
            </div>
            <div class="id">ID</div>
            <div class="pw">Password</div>
            <div class="name">Name</div>
            <div class="email">Email</div>
            <div class="div-wrapper"><div id="userId" class="text-wrapper-3">ID</div></div>
            <div class="overlap-3"><div id="Password" class="text-wrapper-4">Password</div></div>
            <div class="overlap-4"><div id="username" class="text-wrapper-4">Name</div></div>
            <div class="overlap-5"><div id="email" class="text-wrapper-5">Email</div></div>
            <div class="text-wrapper-6">※비밀번호와 이메일만 수정 가능</div>
        </div>
        <div class="text-wrapper-7">MyPage</div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          // 1. header.html 불러오기
          fetch('header.html')
            .then(response => response.text())
            .then(data => {
              document.getElementById('header').innerHTML = data;
              checkLoginStatus(); // header 삽입 후 로그인 상태 확인
            });

          // 2. 로그인 상태 확인 함수
          function checkLoginStatus() {
            fetch('http://localhost:8080/api/users/check-login', {
              method: 'GET',
              credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
              const navButtons = document.getElementById("nav-buttons");

              if (data.isLoggedIn) {
                navButtons.innerHTML = `
                  <a href="mypage.html">MyPage</a>
                  <a href="#" id="logoutBtn">Logout</a>
                `;

                // 로그아웃 이벤트 연결
                document.getElementById("logoutBtn").addEventListener("click", (event) => {
                  event.preventDefault();
                  fetch('http://localhost:8080/api/users/logout', {
                    method: 'GET',
                    credentials: 'include'
                  })
                  .then(response => {
                    if (response.ok) {
                      alert("로그아웃 되었습니다.");
                      window.location.href = "main.html";
                    } else {
                      alert("로그아웃 실패");
                    }
                  });
                });
              } else {
                navButtons.innerHTML = `
                  <a href="join.html">Join</a>
                  <a href="login.html">Login</a>
                `;
              }
            })
            .catch(() => {
              document.getElementById("nav-buttons").innerHTML = `
                <a href="join.html">Join</a>
                <a href="login.html">Login</a>
              `;
            });
          }

          // 3. 마이페이지 정보 로드
          async function loadMyPage() {
            try {
              const response = await fetch('http://localhost:8080/api/users/mypage', {
                method: 'GET',
                credentials: 'include'
              });

              if (response.ok) {
                const data = await response.json();
                document.getElementById('userId').textContent = data.userId;
                document.getElementById('username').textContent = data.username;
                document.getElementById('email').textContent = data.email;
                document.getElementById('Password').textContent = '********';  // 항상 숨김 표시
              } else {
                alert('로그인이 필요합니다.');
                window.location.href = 'login.html';
              }
            } catch (error) {
              console.error('Error:', error);
              alert('서버 오류가 발생했습니다.');
            }
          }

          // 마이페이지 수정 관련
          window.editInfo = function () {
            document.getElementById('passwordModal').style.display = 'flex';
          };

          window.submitPassword = function () {
            const rawPassword = document.getElementById('passwordInput').value;
            if (rawPassword) {
              authenticatePassword(rawPassword);
              document.getElementById('passwordModal').style.display = 'none';
              document.getElementById('passwordInput').value = '';
            } else {
              alert("비밀번호를 입력해주세요.");
            }
          };

          async function authenticatePassword(rawPassword) {
            try {
              const response = await fetch('http://localhost:8080/api/users/check-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ rawPassword: rawPassword })
              });

              if (response.ok) {
                alert("비밀번호 인증 성공! 수정 가능합니다.");
                enableEditFields();
                toggleSaveButton(true);
              } else {
                alert("비밀번호를 확인해주세요.");
              }
            } catch (error) {
              console.error('Error:', error);
              alert('서버 오류가 발생했습니다.');
            }
          }

          function enableEditFields() {
            const emailField = document.getElementById('email');
            emailField.contentEditable = true;
            emailField.style.border = "1px solid #ccc";

              const passwordField = document.getElementById('Password');
              passwordField.innerHTML = `
                <input
                  type="password"
                  id="newPassword"
                  placeholder="새 비밀번호"
                  style="border: none; font-size: 30px; outline: none;"
                />
              `;

              toggleSaveButton(true);
            }

          window.saveChanges = async function () {
            const newEmail = document.getElementById('email').textContent.trim();
            const newPasswordInput = document.getElementById('newPassword');
            const newPassword = newPasswordInput ? newPasswordInput.value.trim() : '';

            if (!newEmail || !newPassword) {
              alert("비밀번호와 이메일 모두 입력해야 합니다.");
              return;
            }

            try {
              const response = await fetch('http://localhost:8080/api/users/update-password-email', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                  newPassword: newPassword,
                  newEmail: newEmail
                })
              });

              if (response.ok) {
                alert("변경되었습니다.");
                disableEditFields();
                toggleSaveButton(false);
                document.getElementById('Password').textContent = '********';
              } else {
                const errorText = await response.text();
                alert("수정 실패: " + errorText);
              }
            } catch (error) {
              console.error('Error:', error);
              alert('서버 오류가 발생했습니다.');
            }
          };

          function disableEditFields() {
            const emailField = document.getElementById('email');
            emailField.contentEditable = false;
            emailField.style.border = "none";

            const passwordField = document.getElementById('Password');
            passwordField.contentEditable = false;
            passwordField.style.border = "none";
          }

          function toggleSaveButton(isEditing) {
            const saveButton = document.querySelector('.save-wrapper');
            const editButton = document.querySelector('.edit-wrapper');

            if (saveButton && editButton) {
              saveButton.style.display = isEditing ? 'block' : 'none';
              editButton.style.display = isEditing ? 'none' : 'block';
            }
          }

          window.deleteAccount = function () {
            if (confirm("정말로 탈퇴하시겠습니까?")) {
              fetch('http://localhost:8080/api/users/delete', {
                method: 'POST',
                credentials: 'include'
              })
              .then(response => {
                if (response.ok) {
                  alert("탈퇴가 완료되었습니다.");
                  window.location.href = 'login.html';
                } else {
                  alert("탈퇴 처리 중 오류가 발생했습니다.");
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('서버 오류가 발생했습니다.');
              });
            }
          };

          // 마이페이지 자동 로드 및 스타일 클래스 적용
          loadMyPage();
          document.querySelector('.edit-wrapper')?.classList.add('button-hover');
          document.querySelector('.overlap-2')?.classList.add('button-hover');
        });
    </script>
  </body>
</html>